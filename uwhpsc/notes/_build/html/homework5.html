

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Homework 5 &mdash; Coursera Edition 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Coursera Edition 1.0 documentation" href="index.html" /> 
  </head>
  <body>

<div style="background-color: #F0D576; text-align: left; padding: 10px 10px 15px 15px">
<table>
<tr>
<td>
<a href="http://www.amath.washington.edu/"><img src="_static/uwamath.gif" border="0" alt="UW AMath"/></a>
</td>
<td>
<font size=5> High Performance Scientific Computing</font>
<br>&nbsp;<br>
<font size=5> Coursera Edition</font>
</td>
</tr>
</table>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html"><font color="#39275b">Contents</font></a>|&nbsp;</li>
        <li><a href="biblio.html"><font color="#39275b">Bibliography</font></a>|&nbsp;</li>

 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Homework 5</a><ul>
<li><a class="reference internal" href="#when-finished">When finished</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/homework5.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="homework-5">
<span id="homework5"></span><h1>Homework 5<a class="headerlink" href="#homework-5" title="Permalink to this headline">Â¶</a></h1>
<p>The goals of this homework are to:</p>
<ul class="simple">
<li>Get more experience with Fortran and OpenMP.</li>
<li>Experiment with coarse grain parallelism.</li>
<li>Learn a bit more about quadrature.</li>
</ul>
<ol class="arabic">
<li><p class="first">I wrote an article recently urging applied mathematicians to share
research code, which appeared in SIAM News.
Some colleagues at other universities have told me it&#8217;s required
reading for their students, so of course I have to assign it too!
It&#8217;s pretty light reading.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.siam.org/news/news.php?id=2064">http://www.siam.org/news/news.php?id=2064</a></li>
<li><a class="reference external" href="http://faculty.washington.edu/rjl/pubs/topten/index.html">some related links</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The IPython notebook <cite>$UWHPSC/codes/homework5/notebook/quadrature2.ipynb</cite>
is an improved version of the notebook from the last homework.  Some of
the functions have been made more general and a discussion has
been added of Simpson&#8217;s Rule, a more accurate formula than Trapezoid.</p>
<p>This notebook is best viewed live so that you can experiment with
changing things in order to explore these examples.  If you have a
sufficiently recent version of the notebok installed (see
<a class="reference internal" href="ipython_notebook.html#ipython-notebook"><em>IPython_notebook</em></a>) then you should be able to do:</p>
<div class="highlight-python"><pre>$ cd $UWHPSC/codes/homework5/notebook
$ ipython notebook --pylab inline</pre>
</div>
<p>and then click on the <cite>quadrature2</cite> notebook.</p>
<p>You can also view it at
<a class="reference external" href="https://www.wakari.io/sharing/bundle/rjleveque/quadrature2">https://www.wakari.io/sharing/bundle/rjleveque/quadrature2</a> .
If you have created a Wakari account, you should be able to
download it to your account to try it out.</p>
<p>You can also view a static version of the notebook, which is in
<cite>$UWHPSC/codes/homework5/notebook/quadrature2.pdf</cite>.</p>
<p>There is also a Python script version of the code in the notebook at
<cite>$UWHPSC/codes/homework5/notebook/quadrature.py</cite> if you
find that easier to experiment with.
(But see the comments at the top of that file.)</p>
<p>Experiment with the notebook or the module to make sure you understand
the material presented.</p>
<p>Study this code to make sure you understand it.</p>
</li>
<li><p class="first">The directory <cite>$UWHPSC/codes/homework5/</cite> also contains Fortran code
that implements the last part of homework 4, with some added
enhancements.  In particular:</p>
<ul class="simple">
<li>timing has been added</li>
<li>a counter has been added to the f2 function to count how many times it
is called, and this is printed at the end.</li>
<li>fevals is a module variable (shared between threads) to store the
number of function calls by each thread when OpenMP is used.</li>
<li>the <cite>error_table</cite> subroutine has a new input parameter <cite>method</cite> to
pass in the function that approximates the integral.  When this is
called from the main program <cite>test.f90</cite> the function <cite>trapezoid</cite> is
passed in.  In this homework you will also test Simpson&#8217;s rule.</li>
<li>The function <cite>f2</cite> has been moved to a module and the parameter <cite>k</cite>
is a module variable.</li>
</ul>
<p>Study this code and experiment with it.</p>
<p>With 4 threads it might produce something like the following (timings
will depend on how many cores you have):</p>
<div class="highlight-python"><pre>Using  4 threads
true integral:   6.00136745954910E+00

       n         approximation        error       ratio
      50  6.00200615142458E+00    6.387E-04    0.000E+00
     100  6.01762134207395E+00    1.625E-02    3.929E-02
     200  5.99787907396672E+00    3.488E-03    4.659E+00
     400  5.99537682567465E+00    5.991E-03    5.823E-01
     800  6.00057196798962E+00    7.955E-04    7.531E+00
    1600  6.00118591794817E+00    1.815E-04    4.382E+00
    3200  6.00132301603504E+00    4.444E-05    4.085E+00
    6400  6.00135640717690E+00    1.105E-05    4.021E+00
   12800  6.00136470029559E+00    2.759E-06    4.006E+00
   25600  6.00136677000209E+00    6.895E-07    4.002E+00
   51200  6.00136728718235E+00    1.724E-07    4.000E+00
  102400  6.00136741645906E+00    4.309E-08    4.000E+00

Elapsed time =   0.00554200 seconds
CPU time =   0.01890300 seconds
fevals by thread  0:         51211
fevals by thread  1:         51187
fevals by thread  2:         51187
fevals by thread  3:         51165
Total number of fevals:     204750</pre>
</div>
<p>You do not need to code anything for this part.</p>
</li>
<li><p class="first">Create a new subdirectory <cite>$MYHPSC/homework5</cite> for the code you write
below.  You can use the code provided as a starting point.</p>
<p>Create a new module <cite>quadrature2.f90</cite> by starting with <cite>quadrature.f90</cite>
and adding a new function <cite>simpson</cite> that
implements Simpson&#8217;s rule.  It should have the same input arguments as
<cite>trapezoid</cite>.</p>
<p>Write a new main program <cite>test2.f90</cite> to test this.
Check that it is 4th order accurate on the function <cite>f2</cite>
provided with various values of <cite>k</cite>.  Check it also with some other
functions if you want.</p>
<p><strong>Note:</strong> this module should also be called <cite>quadrature2</cite>, not just the
file name, i.e. it should start with the line:</p>
<div class="highlight-python"><pre>module quadrature2</pre>
</div>
<p>and <cite>test2.f90</cite> should:</p>
<div class="highlight-python"><pre>use quadrature2, only: ...</pre>
</div>
</li>
<li><p class="first">Your <cite>simpson</cite> routine should include an <cite>omp parallel do</cite> loop similar
to <cite>trapezoid</cite>.  Make sure it gives the same results in the error table
for both with and without the <cite>-fopenmp</cite> during compilation, and for
different choices of the number of threads.</p>
<p>Remember that you can run with more threads than your computer has cores
and it should still work, but will probably make it run slower rather
than faster.</p>
</li>
<li><p class="first">Create a new version of the <cite>quadrature</cite> module named <cite>quadrature3</cite> that
has no parallel loops in <cite>trapezoid</cite> and instead has a parallel do loop
in the <cite>error_table</cite> routine when it loops over the different values of
<cite>n</cite> to test from the <cite>nvals</cite> array.</p>
<p>In this loop make <cite>last_error</cite> a <em>firstprivate</em> variable and think about
what other variables need to be <em>private</em>.  More about this below.</p>
<p>Test this version with a new test program <cite>test3.f90</cite> that calls
<cite>error_table</cite> with <cite>method = trapezoid</cite>.</p>
<p>Note the following:</p>
<ul class="simple">
<li>If you run this with more than one thread, the different lines of the
error table probably will not print out in the same order as on a
single thread.</li>
<li>The values of <cite>ratio</cite> in the table will be wrong relative to the single
thread code for various <cite>n</cite>.  Make sure you understand why.
(The values of the <cite>error</cite> should still agree with the single-thread
code, however.)</li>
<li>This is not a very good way to try to parallelize this code because
it does not have good <em>load balancing</em>.  If you run with 2 threads, for
example, one of them will do many more function evaluations than the
other thread, if you allow OpenMP to split up the values of <cite>n</cite> between
threads in the default manner.  Think about why this is so and make
sure you understand what&#8217;s going on.</li>
</ul>
<p>Make the changes for the next two parts also in your <cite>quadrature3.f90</cite> version.</p>
</li>
<li><p class="first">Because of the load-balancing issue just mentioned, it is useful to
include another clause in the <cite>omp parallel do</cite> loop directive in error
table:</p>
<div class="highlight-python"><pre>!$omp parallel do ...  &amp;   ! whatever you needed before
!$omp          schedule(dynamic)
do j=1,size(nvals)</pre>
</div>
<p>This instructs the compiler to split up the values of <cite>j</cite> from 1 to
<cite>size(nvals)</cite> dynamically rather than deciding in advance that the first
half of the values will go to Thread 0 and the second half to Thread 1,
for example.  Instead the two threads would start working on <cite>j=1</cite> and
<cite>j=2</cite> and whichever finishes first would start on <cite>j=3</cite>.  This should
give a somewhat better balance between threads.</p>
<p>Note that it can&#8217;t do a perfect job for this example since computing the
error for the last value of <cite>j</cite> (the largest value of <cite>n</cite>)
takes  more function evaluations that all the others put together!</p>
</li>
<li><p class="first">In order to improve load balancing, reorder the parallel loop so that
<cite>n</cite> is decreasing rather than increasing via:</p>
<div class="highlight-python"><pre>do j=size(nvals),1,-1</pre>
</div>
<p>Think about why this is better.</p>
<p>In this case you might get results like this:</p>
<div class="highlight-python"><pre>Using  4 threads
true integral:   6.00136745954910E+00

       n         approximation        error       ratio
   12800  6.00136470029559E+00    2.759E-06    0.000E+00
    6400  6.00135640717688E+00    1.105E-05    2.497E-01
   25600  6.00136677000212E+00    6.895E-07    0.000E+00
    1600  6.00118591794817E+00    1.815E-04    3.798E-03
    3200  6.00132301603504E+00    4.444E-05    2.487E-01
     800  6.00057196798962E+00    7.955E-04    2.282E-01
     400  5.99537682567465E+00    5.991E-03    7.419E-03
     200  5.99787907396672E+00    3.488E-03    2.280E-01
     100  6.01762134207395E+00    1.625E-02    3.686E-01
      50  6.00200615142457E+00    6.387E-04    5.462E+00
   51200  6.00136728718236E+00    1.724E-07    0.000E+00
  102400  6.00136741645906E+00    4.309E-08    0.000E+00

Elapsed time =   0.00621600 seconds
CPU time =   0.01550900 seconds
fevals by thread  0:         51200
fevals by thread  1:        102400
fevals by thread  2:         22600
fevals by thread  3:         28550
Total number of fevals:     204750</pre>
</div>
<p>(Can you guess from this which thread got which values of <cite>n</cite>?)
Notice that the table is very much out of order in this case, since lines
were printed as threads finished their work.</p>
<p>One could clean up the table by keeping the approximation and error
values for each n in a short array and then printing at the end in
the proper order, along with the correct ratios.  But you don&#8217;t need
to do this for the assignment.</p>
<p>The changes for Problems 6,7,8 should all be made in the same version.
So what you end up with in
<cite>quadrature3.f90</cite> will have the parallel loop in <cite>error_table</cite>,
will use dynamic scheduling, and have the loop on <cite>j</cite> reordered.
The <cite>test3.f90</cite> program should call <cite>error_table</cite> with <cite>method =
trapezoid</cite>.</p>
</li>
<li><p class="first">Suppose we want to compute an integral in two space dimensions of the
form</p>
<p><span class="math">\(\int_a^b \int_c^d g(x,y) \, dy \, dx\)</span></p>
<p>This can be rewritten as <span class="math">\(\int_a^b f(x) \, dx\)</span> where the function
<span class="math">\(f(x) = \int_c^d g(x,y) \, dy\)</span>.
As usual, we could approximate the integral of <span class="math">\(f(x)\)</span> by the
trapezoid rule in <cite>x</cite>.
But now for each <cite>x</cite>, in order to approximate <span class="math">\(f(x)\)</span>
we must approximate <span class="math">\(f(x)\)</span> by a trapezoid rule
approximation to the integral of <span class="math">\(g(x,y)\)</span> in <span class="math">\(y\)</span>.</p>
<p>Create a new directory <cite>homework5/quad2d</cite> that contains new versions of
the codes <cite>functions.f90</cite>, <cite>quadrature.f90</cite>, and <cite>test.f90</cite> that can be
used to approximate</p>
<p><span class="math">\(\int_0^2 \int_1^4 \sin(x+y)~dy~dx\)</span></p>
<p>for which the true value can be easily calculated for comparison.</p>
<p>In this case the function <cite>f(x)</cite> defined in <cite>functions.f90</cite> should
contain an implementation of the trapezoid rule (in <cite>y</cite>) that estimates
<span class="math">\(\int_1^4 g(x,y) \, dy\)</span>  for any value <cite>x</cite>.</p>
<p>The <cite>functions</cite> module should also contain a function <cite>g(x,y)</cite> that will
be called by <cite>f</cite>.</p>
<p>For the trapezoid rule in <cite>y</cite>, always use <cite>ny = 1000</cite> points.
(Not a great idea, see below, but let&#8217;s keep it simple.)</p>
<p>Modify the test program so that it produces an error table for ten
values of <cite>n</cite> as shown in the sample output below.  (These are the
values used in the trapezoid rule approximation in <cite>x</cite>).</p>
<p>Also modify your code so that it keeps track of how many evaluations of
the function <cite>g(x,y)</cite> each thread does, by introducing a new module
variable <cite>gevals</cite> that is initialized and incremented appropriately.</p>
<p>Start with the modules provided in <cite>$UWHPSC/codes/homework5</cite> and you can
leave <cite>quadrature.f90</cite> alone.  In this module, OpenMP is used for the loop
in the <cite>trapezoid</cite> routine.  You do not need to add it to your new
trapezoid loop in the definition of <cite>f(x)</cite>.  (You would not want to
since they you would have nested parallel loops.)</p>
<p>Sample output might look like this:</p>
<div class="highlight-python"><pre>Using  4 threads
true integral:  -1.17773797385703E+00

       n         approximation        error       ratio
       5 -1.15309805294824E+00    2.464E-02    0.000E+00
      10 -1.17288644038560E+00    4.852E-03    5.079E+00
      20 -1.17664941136820E+00    1.089E-03    4.457E+00
      40 -1.17747897159959E+00    2.590E-04    4.203E+00
      80 -1.17767418488683E+00    6.379E-05    4.060E+00
     160 -1.17772156012371E+00    1.641E-05    3.886E+00
     320 -1.17773323092813E+00    4.743E-06    3.461E+00
     640 -1.17773612733693E+00    1.847E-06    2.569E+00
    1280 -1.17773684879809E+00    1.125E-06    1.641E+00
    2560 -1.17773702883453E+00    9.450E-07    1.191E+00

Elapsed time =   0.10095600 seconds
CPU time =   0.36504200 seconds
fevals by thread  0:          1298
fevals by thread  1:          1278
fevals by thread  2:          1278
fevals by thread  3:          1261
Total number of fevals:       5115
gevals by thread  0:       1298000
gevals by thread  1:       1278000
gevals by thread  2:       1278000
gevals by thread  3:       1261000
Total number of gevals:    5115000</pre>
</div>
<p>Note that the error decreases at the expected rate initially but for
larger values of <cite>n</cite> we do not get the factor of 4 improvement we might
hope for.  This is because the inner integral in <cite>y</cite> is always approximated
with 1000 points so there is an error in the values of <cite>f(x)</cite> produced
that does not
decrease as we increase the number of points used for the outer integral.
(A better idea of course would be to decrease <cite>ny</cite> along with <cite>n</cite>.)</p>
<p>Note that you expect the total number of <cite>g</cite> evaluations to be 1000
times larger than the total number of <cite>f</cite> evaluations.</p>
</li>
</ol>
<div class="section" id="when-finished">
<h2>When finished<a class="headerlink" href="#when-finished" title="Permalink to this headline">Â¶</a></h2>
<p>Your homework5 directory should contain:</p>
<ul class="simple">
<li>functions.f90   (unchanged from <cite>$UWHPSC/codes/homework5</cite>)</li>
<li>quadrature2.f90</li>
<li>test2.f90</li>
<li>quadrature3.f90</li>
<li>test3.f90</li>
<li>Makefile (optional if you find it useful to enhance what&#8217;s provided)</li>
<li>quad2d/quadrature.f90  (original from <cite>$UWHPSC/codes/homework5</cite> should work here)</li>
<li>quad2d/functions.f90   (with f modified and g added)</li>
<li>quad2d/test.f90    (modified for this problem)</li>
<li>Makefile (optional)</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html"><font color="#39275b">Contents</font></a>|&nbsp;</li>
        <li><a href="biblio.html"><font color="#39275b">Bibliography</font></a>|&nbsp;</li>

 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Randall J. LeVeque, CC BY.
      Last updated on Aug 08, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>